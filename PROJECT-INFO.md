# Nightscout Docker Project - Comprehensive Guide

## Project Overview

This is a production-ready Docker deployment for Nightscout (Continuous Glucose Monitoring visualization platform) with comprehensive DevOps tooling, Cloudflare tunnel integration, and Proxmox deployment support.

### Key Components

- **Nightscout Application**: Web-based CGM data visualization (v15.0.3)
- **MongoDB Database**: Data persistence (v4.4)
- **Cloudflare Tunnel**: Secure external access without port forwarding
- **Docker Compose**: Container orchestration
- **Comprehensive Scripts**: Setup, validation, debugging, and maintenance

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cloudflare    │    │   Docker Host   │    │   Proxmox VM    │
│     Tunnel      │◄──►│   (Optional)    │◄──►│   (Production)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   External      │    │   Nightscout    │    │   MongoDB       │
│   Access        │    │   Container     │    │   Container     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## File Structure

### Core Configuration
- `docker-compose.yml` - Local development configuration
- `docker-compose.proxmox.yml` - Production Proxmox deployment
- `Dockerfile` - Custom Nightscout image (if needed)
- `.env.example` - Environment template

### Setup and Management Scripts
- `setup.sh` - Main setup script with interactive and automated modes
- `setup-cloudflare.sh` - Cloudflare tunnel configuration
- `validate.sh` - Configuration validation
- `diagnose.sh` - Comprehensive diagnostics
- `debug-tunnel.sh` - Cloudflare tunnel troubleshooting
- `fix-tunnel.sh` - Quick tunnel fixes
- `cleanup.sh` - Complete cleanup
- `cleanup-tunnels.sh` - Tunnel cleanup

### Migration and Backup
- `export-atlas-db.sh` - MongoDB Atlas export
- `import-to-vm.sh` - Data import to VM
- `setup-atlas-migration.sh` - Atlas migration setup
- `transfer-cloudflare-cert.sh` - Certificate transfer

### Documentation
- `README.md` - Main documentation
- `DEPLOY.md` - Proxmox deployment guide
- `MIGRATION.md` - Migration procedures
- `SECURITY.md` - Security considerations
- `TODO.md` - Future enhancements

## Quick Start Guide

### 1. One-Liner Setup (Recommended)
```bash
# Complete automated setup with Cloudflare tunnel
./setup.sh --domain nightscout.yourdomain.com --setup-tunnel

# Start services
docker-compose up -d

# Access at https://nightscout.yourdomain.com
```

### 2. Step-by-Step Setup
```bash
# Basic setup
./setup.sh --domain your.domain.com

# Configure Cloudflare tunnel
./setup-cloudflare.sh --domain your.domain.com

# Validate configuration
./validate.sh

# Start services
docker-compose up -d
```

### 3. Production Deployment (Proxmox)
```bash
# Transfer to Proxmox server
scp -r . user@proxmox-server:/opt/nightscout/

# SSH to server and setup
ssh user@proxmox-server
cd /opt/nightscout
./setup.sh --domain your.domain.com --setup-tunnel

# Deploy with production config
docker-compose -f docker-compose.proxmox.yml up -d
```

## Environment Configuration

### Required Variables
```bash
# Security (auto-generated by setup.sh)
API_SECRET=your_long_random_string
MONGO_INITDB_ROOT_PASSWORD=your_mongodb_password

# MongoDB connection
MONGO_CONNECTION=mongodb://root:password@mongo:27017/nightscout?retryWrites=true&w=majority

# Basic settings
TZ=America/New_York
DISPLAY_UNITS=mg/dl
CUSTOM_TITLE=Your Nightscout Site

# Cloudflare tunnel
CLOUDFLARE_DOMAIN=your.domain.com
CLOUDFLARE_TUNNEL_ID=your_tunnel_id
```

### Optional Features
```bash
# Enable specific Nightscout features
ENABLE=careportal basal dbsize rawbg iob maker cob bwp cage iage sage boluscalc pushover treatmentnotify loop pump profile food openaps bage alexa override cors

# Alarms
ALARM_HIGH=260
ALARM_LOW=55
ALARM_URGENT_HIGH=370
ALARM_URGENT_LOW=40
```

## Docker Services

### Nightscout Container
- **Image**: `nightscout/cgm-remote-monitor:15.0.3`
- **Port**: `8080:1337`
- **Health Check**: HTTP endpoint `/api/v1/status`
- **Restart Policy**: `unless-stopped`
- **Features**: Production-ready with security headers

### MongoDB Container
- **Image**: `mongo:4.4`
- **Data Volume**: `nightscout_mongo_data`
- **Authentication**: Root user with password
- **Restart Policy**: `unless-stopped`
- **Logging**: JSON format with rotation

### Network Configuration
- **Network**: `nightscout_network` (bridge)
- **Isolation**: Containers communicate via internal network
- **External Access**: Cloudflare tunnel only

## Cloudflare Tunnel Integration

### Automatic Setup
The setup scripts automatically:
1. Create tunnel with predictable naming
2. Configure DNS routing
3. Set up service configuration
4. Install and start cloudflared service

### Manual Management
```bash
# Check tunnel status
./tunnel-status.sh

# View tunnel logs
./tunnel-logs.sh

# Debug tunnel issues
./debug-tunnel.sh

# Fix common problems
./fix-tunnel.sh

# Cleanup unused tunnels
./cleanup-tunnels.sh
```

## Monitoring and Maintenance

### Health Checks
```bash
# Validate configuration
./validate.sh

# Comprehensive diagnostics
./diagnose.sh

# Check container status
docker-compose ps

# View logs
docker-compose logs -f
```

### Backup Procedures
```bash
# MongoDB backup
docker exec nightscout_mongo mongodump --out /data/db/backup

# Volume backup
docker run --rm -v nightscout_mongo_data:/data -v $(pwd):/backup alpine tar czf /backup/mongo-backup.tar.gz -C /data .

# Complete backup script
./backup.sh
```

### Update Procedures
```bash
# Update Nightscout
docker-compose down
docker-compose pull
docker-compose up -d

# Update with backup
./update.sh
```

## Security Considerations

### Network Security
- No direct port exposure (Cloudflare tunnel only)
- Internal Docker network isolation
- HTTPS enforced via Cloudflare
- HSTS headers enabled

### Authentication
- API_SECRET for Nightscout API access
- MongoDB root authentication
- Cloudflare tunnel certificate-based auth

### Data Protection
- MongoDB data persistence
- Regular backup procedures
- Secure credential generation
- Environment variable isolation

## Troubleshooting

### Common Issues

#### Container Won't Start
```bash
# Check logs
docker-compose logs nightscout
docker-compose logs mongo

# Validate configuration
./validate.sh

# Check resource usage
docker stats
```

#### Cloudflare Tunnel Issues
```bash
# Comprehensive debugging
./debug-tunnel.sh

# Check service status
sudo systemctl status cloudflared

# View detailed logs
sudo journalctl -u cloudflared -f
```

#### Database Connection Issues
```bash
# Test MongoDB connectivity
docker exec nightscout_mongo mongosh --eval "db.adminCommand('ping')"

# Check MongoDB logs
docker-compose logs mongo

# Restart MongoDB
docker-compose restart mongo
```

### Diagnostic Commands
```bash
# System information
./diagnose.sh

# Network connectivity
curl -f http://localhost:8080/api/v1/status

# Container health
docker-compose ps
docker-compose top

# Resource usage
docker stats
df -h
free -h
```

## Deployment Options

### Local Development
- Use `docker-compose.yml`
- Access via `http://localhost:8080`
- Full development environment

### Proxmox VM (Production)
- Use `docker-compose.proxmox.yml`
- Automated backups via Proxmox
- Resource monitoring
- High availability setup

### LXC Container (Development Only)
- Limited security isolation
- Shared kernel resources
- Quick development setup

## Performance Considerations

### Resource Requirements
- **Minimum**: 2GB RAM, 2 CPU cores, 10GB storage
- **Recommended**: 4GB RAM, 4 CPU cores, 20GB storage
- **Production**: 8GB RAM, 4+ CPU cores, 50GB+ storage

### Optimization
- MongoDB data volume on fast storage
- Regular log rotation
- Container resource limits
- Monitoring and alerting

### Scaling
- Horizontal scaling not supported (single instance)
- Vertical scaling via resource allocation
- Load balancing via Cloudflare (if needed)

## Development Workflow

### Adding Features
1. Modify `docker-compose.yml` for new services
2. Update environment variables in `.env`
3. Test with `./validate.sh`
4. Document changes in appropriate README

### Custom Scripts
1. Follow existing script patterns
2. Include error handling and colored output
3. Add to appropriate documentation
4. Test on both local and production environments

### Testing
```bash
# Validate configuration
./validate.sh

# Test deployment
docker-compose up -d
curl http://localhost:8080/api/v1/status

# Test cleanup
./cleanup.sh
```

## Support and Maintenance

### Regular Tasks
- [ ] Weekly: Check container health and logs
- [ ] Monthly: Update Docker images
- [ ] Quarterly: Review security settings
- [ ] Annually: Full backup and restore test

### Monitoring Checklist
- [ ] Container status (running/healthy)
- [ ] Cloudflare tunnel connectivity
- [ ] MongoDB performance
- [ ] Disk space usage
- [ ] Memory and CPU usage
- [ ] Network connectivity

### Emergency Procedures
1. **Service Down**: Check logs, restart containers
2. **Data Loss**: Restore from backup
3. **Tunnel Issues**: Run `./debug-tunnel.sh`
4. **Security Breach**: Rotate credentials, review logs

## Future Enhancements

See `TODO.md` for planned features including:
- Prometheus monitoring stack
- Advanced alerting
- Automated scaling
- Enhanced security features
- Performance optimization

---

**Last Updated**: January 2025  
**Version**: 15.0.3 (Nightscout)  
**Compatibility**: Docker 20+, Docker Compose 2+, Ubuntu 20.04+ 